# 2025.07 - Substrate 技术更新速递

---

## 重要提交和发布

### 1. 修复多页面选择器中的获胜者计算错误

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/8987) 修复了多页面选择器（multi-page winner）中的一个关键计算错误，确保在 aggressive trimming 场景下能正确计算总获胜者数量。

这个问题的产生背景是在原先的实现中，`MaxWinnersPerPage` 被错误地视为整体最大获胜者数量，而不是每页的最大获胜者数量。修复后正确地将总获胜者数量计算为 `Pages * MaxWinnersPerPage`。

主要改进内容：

- **计算逻辑修正**：在 `FullSupportsOfMiner` 中调整了获胜者总数的计算逻辑，从错误的单页最大值改为正确的多页总和
- **测试用例验证**：添加了完整的测试用例验证修复效果，测试配置包括 `Pages=2`、`MaxWinnersPerPage=2`、`desired_targets=3`、`MaxBackersPerWinner=1`
- **边缘场景覆盖**：防止在 aggressive trimming 场景下出现 `WrongWinnerCount` 错误

开发者指出这是一个在生产环境中 99% 情况下不会触发的边缘场景，但对于 1% 的特殊情况非常重要。这个修复确保了多页面选择器能正确处理超过单页最大获胜者数量的情况，提升了系统的健壮性。

### 2. 修复 GRANDPA 共识机制中的权威集变更竞态条件

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9015) 解决了 GRANDPA 共识机制在权威集变更过程中的竞态条件问题，该问题导致 Versi-net 网络中频繁出现节点断开连接的情况。

问题场景描述：在权威集变更期间，节点可能会发送带有过时集合 ID 的 justification，这会导致签名验证失败并引起节点断开连接。在 Versi-net 部署的 40 个验证者中，每 15-20 分钟就有 10 个验证者断开连接。

主要改进内容：

- **韧性签名验证机制**：实现了能够检查先前集合 ID 的韧性签名验证。当签名解码失败时，系统会验证前一个集合 ID，如果能产生有效签名，则传播"过时 justification"错误而不是断开连接
- **同步引擎优化**：更新同步引擎以处理过时的 justification 而不禁用对等节点，避免了不必要的网络分区
- **核心函数改进**：修改了 `check_message_signature_with_buffer` 函数以验证先前的集合 ID

部署效果：在 Versi-net 上部署后，网络稳定性显著改善，有效解决了权威集转换期间的频繁断连问题。

这个 PR 关闭了相关 issue #8872 和 #1147，代表了对共识机制权威转换期间网络韧性的重要改进。

### 3. 异步质押系统中的违规存储优化和内存管理改进

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9049) 对异步质押系统（staking-async）中的 ah-client pallet 进行了重要的违规存储优化，防止无界内存增长并提升违规处理的效率。

该 PR 解决了在 buffered offence 处理过程中的潜在内存管理问题，相关安全发现参见 [issue #525](https://github.com/paritytech-secops/srlabs_findings/issues/525)。

主要改进内容：

- **防止违规重复**：为同一会话中的相同违规者只保留最高的 slash 比例，引入了带有可选 reporter 和 slash fraction 字段的新 `BufferedOffence` 结构

- **存储结构重构**：将存储从 `Vec<(SessionIndex, Vec<Offence>)>` 转换为嵌套的 `BTreeMap<SessionIndex, BTreeMap<AccountId, BufferedOffence>>`，提供更高效的查找和去重能力

- **违规处理改进**：
  - 添加了 `MaxOffenceBatchSize` 配置参数用于控制批处理大小
  - 以可配置大小的批次处理违规
  - 每个区块仅发送第一个会话的违规

- **性能增强**：
  - 为 `process_buffered_offences` 实现了基准测试基础设施
  - 添加了 WeightInfo trait，为 `on_initialize` 钩子中的批处理提供基准权重

这些优化确保了异步质押系统在处理大量违规时能够保持良好的内存使用和处理性能，提升了系统的整体稳定性和可扩展性。

### 4. 异步质押系统增强惩罚处理期间的资金提取限制

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9079) 对异步质押系统进行了重要的安全改进，确保在处理和应用惩罚（slashing）期间，防止用户提取资金，维护区块链网络惩罚机制的完整性。

该改进解决了一个关键的边缘场景：当大量违规报告导致处理速度减慢，或某些惩罚在 bonding period 结束后仍未处理完成时，可能出现用户绕过惩罚机制提取资金的风险。

主要改进内容：

- **提款条件限制**：只允许提取资金到"最后完全处理的 offence era"，如果前一个 era 存在未应用的惩罚，将阻止提款操作
- **四阶段违规处理机制**：
  - 在中继链上报告违规
  - 在资产中心进行排队
  - 处理违规
  - 应用惩罚
- **安全机制增强**：
  - 拒绝处理过于陈旧的 offence
  - 在 offence 处理管道中增加额外检查
  - 使用 ActiveEra 替代 CurrentEra 进行管理
- **手动应用机制**：提供 permissionless 的 `apply_slash` 调用以手动应用惩罚，确保惩罚不会被遗漏

这是一个防御性的重要改进，通过增加额外的安全检查来确保网络的惩罚机制不会被绕过，维护了质押系统的经济安全性。

### 5. Revive EVM 兼容性：解决以太坊小数精度问题

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9101) 解决了 Polkadot SDK 中 Revive 系统与以太坊小数精度兼容性的重要问题，提升了跨链交互的兼容性。

问题背景：Polkadot 将 1 DOT 定义为 10^10 plancks，而以太坊将 1 ETH 表示为 10^18 wei。这种差异导致小于 10^8 wei 的值无法在原生余额中表达，使用此类小值的合约会因 "DecimalPrecisionLoss" 错误而回滚。

主要改进内容：

- **精度标准化**：解决了十进制精度限制，使 Revive 系统能够正确处理以太坊标准的 18 位小数精度
- **工具兼容性提升**：大多数前端库、钱包和编译器都期望 18 位小数，此改进确保了与这些工具的完全兼容
- **合约交互优化**：修复了之前因精度差异导致的合约回滚问题，使以太坊合约能够在 Polkadot 生态中正常运行
- **跨链互操作性**：标准化小数表示以匹配以太坊主网预期，改善了 Ethereum 和 Polkadot 生态系统之间的互操作性

这个改进对于希望在 Polkadot 上运行以太坊兼容合约的开发者来说意义重大，消除了一个重要的技术障碍。

### 6. 增强验证上下文中哈希映射的随机性和安全性

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9127) 对 Polkadot SDK 中的哈希映射进行了重要的安全性增强，特别是在验证上下文中增加了额外的随机性保护。

主要改进内容：

- **哈希器替换**：将验证上下文中的 BTreeMap 替换为更安全的 HashMaps，并修改了 TrieCache、TrieRecorder 和 MemoryDB 的哈希器
- **多源随机性**：在默认生成的随机性基础上，额外添加中继链和平行链区块哈希作为随机性种子
- **不可预测性增强**：通过添加区块哈希作为额外随机性源，大幅增加了哈希映射的不可预测性
- **动态随机性**：每个区块的随机性都会发生变化，用户无法提前控制或预测这些区块哈希

**安全性提升**：

- 提高了哈希映射在验证过程中的安全性
- 显著降低了潜在的哈希碰撞和恶意操纵风险
- 为整个系统增加了一层额外的随机性保护层

这个改进对于维护 Polkadot 网络的安全性具有重要意义，特别是在面对潜在的哈希攻击时提供了更强的防护能力。该 PR 已被合并到 master 分支，并回溯到 stable2506 和 unstable2507 分支。

### 7. 使用 zombienet-sdk 重写验证者禁用测试

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9128) 对验证者禁用功能的测试进行了现代化改造，使用 zombienet-sdk 测试框架重写了现有测试，提升了测试的健壮性和灵活性。

主要改进内容：

- **测试框架升级**：将现有测试迁移到使用 zombienet-sdk，采用更现代化的测试方法
- **验证者配置优化**：修改测试配置使恶意验证者默认处于易受攻击状态，更准确地模拟真实场景
- **验证机制增强**：添加了基于日志和存储的验证者禁用行为断言，确保禁用机制正常工作
- **测试基础设施改进**：为验证者相关场景提供更强大和全面的测试基础设施

**技术细节**：

- 测试位置：`polkadot/zombienet-sdk-tests/tests/functional/validator_disabling.rs`
- 配置变更：允许在测试期间禁用验证者的配置修改
- 验证方法：添加基于日志和可能基于存储的已禁用验证者验证

这个改进解决了 issue #9085，代表了 Polkadot SDK 测试基础设施的增量改进，专注于更灵活和全面的验证者行为测试。通过现代化的测试方法，确保了验证者禁用机制的可靠性和正确性。

### 8. 解决资产中心迁移期间的保留资产转账问题

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9137) 解决了 Polkadot SDK 中 `transfer_assets` 函数在资产中心迁移（Asset Hub Migration, AHM）期间的保留资产问题，确保迁移过程的平稳进行。

问题背景：在 AHM 之前，网络原生资产（如 DOT、KSM、WND、PAS）的保留位置将从中继链移动到资产中心。这种转换可能导致跨链保留转账在迁移期间出现不一致性问题。

主要改进内容：

- **临时转账限制**：在 AHM 之前，暂时禁用网络原生资产的跨链保留转账，防止迁移期间的资产状态不一致
- **保留位置变更处理**：妥善处理资产保留位置从中继链到资产中心的转换过程
- **测试用例完善**：添加了相应的测试用例以验证迁移期间的正确行为
- **平滑过渡机制**：为未来迁移后的正确配置做准备，确保迁移完成后功能正常恢复

**技术实现**：

- 修改了 `transfer_assets` 函数的逻辑，添加了迁移期间的特殊处理
- 实现了临时禁用机制，避免在关键迁移窗口期间的资产状态混乱

这个改进确保了资产中心迁移的安全性和可靠性，该 PR 已被合并到 master 分支并回溯到多个稳定版本分支。

### 9. BABE 共识机制验证流程重构

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9147) 对 Polkadot SDK 中的 BABE（盲分配区块链扩展）共识机制进行了重要的验证流程重构，将验证过程在 Verifier 和导入队列之间进行了更合理的分离。

这是将复杂验证逻辑重构的两阶段计划中的第一部分，专注于 BABE 共识机制的优化（第二部分将处理 AURA 共识）。

主要改进内容：

- **验证职责分离**：
  - 在 `Verifier` 中保留无状态验证逻辑
  - 将大部分验证逻辑迁移到导入队列中处理
- **架构模块化**：通过重新构建区块验证工作流程，使 BABE 共识机制更加模块化和易于理解
- **错误处理增强**：改进了错误检查机制和区块验证过程，提供更详细的错误信息
- **代码可维护性提升**：通过将复杂检查移动到导入队列，简化了验证逻辑的复杂性

**技术影响**：

- 使共识机制更加健壮，通过分离关注点降低了验证过程的复杂性
- 为后续的 AURA 共识重构奠定了基础
- 提高了代码的可读性和可维护性

这个重构经过了多轮评审和改进，确保了验证流程的正确性和性能。该 PR 已成功合并到 master 分支。

### 10. 修复 AssetsInHolding 资产合并的关键缺陷

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9179) 修复了 `AssetsInHolding` 类中 `subsume_assets` 方法的一个关键缺陷，该缺陷可能导致在合并资产实例时发生资产丢失。

问题描述：当合并两个 `AssetsInHolding` 实例时，在某些条件下会错误地覆盖而非累加相同类型的资产，导致原有资产被意外替换。

**具体问题示例**：

```rust
let mut t1 = AssetsInHolding::new();
t1.subsume(CFP(400));

let mut t2 = AssetsInHolding::new();
t2.subsume(CF(100));
t2.subsume(CFP(100));

t1.subsume_assets(t2);
```

- **错误行为**：只保留 `t2` 中的资产，`CFP(400)` 被 `CFP(100)` 替代
- **预期行为**：正确累加资产，应该得到 `CF(100)` 和 `CFP(500)`

主要修复内容：

- **合并逻辑重写**：重新实现了 `subsume_assets` 方法，确保正确的资产累加而非替换
- **资产保护机制**：修复了可能导致资金损失的关键逻辑缺陷
- **测试验证**：添加了相应的测试用例以验证修复的正确性

**重要性**：

这个修复对于 XCM 资产处理的安全性至关重要，防止了在跨链资产操作中可能发生的意外资产丢失，确保了资产合并操作的正确性和安全性。

### 11. 修复桥接测试的创世配置预设

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9185) 修复了桥接测试基础设施中的创世配置预设问题，提升了桥接测试的可靠性。

该 PR 解决了 issue #9116 中描述的桥接测试相关问题，确保了 Asset Hub 平行链在测试网络中的正确配置。

主要修复内容：

- **创世配置更新**：修改了 Asset Hub Rococo 和 Westend 运行时的创世配置文件
- **具体文件调整**：
  - `cumulus/parachains/runtimes/assets/asset-hub-rococo/src/genesis_config_presets.rs`
  - `cumulus/parachains/runtimes/assets/asset-hub-westend/src/genesis_config_presets.rs`
- **测试基础设施改进**：确保桥接测试基础设施的正确配置和稳定运行
- **网络兼容性**：保证了 Asset Hub 平行链在 Rococo 和 Westend 测试网络中的正确初始化

**影响和意义**：

- 提高了桥接测试的可靠性和稳定性
- 确保了 Asset Hub 平行链在测试环境中的正确配置
- 为跨链桥接功能的开发和测试提供了更稳定的基础设施

该 PR 经过了多位团队成员的协作验证，包括 bkontur、karolk91 和 franciscoaguirre 等的评审，确保了修复的质量和可靠性。

### 12. 改进延迟惩罚取消机制的实现

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9187) 对 Polkadot SDK 中的 `cancel_deferred_slash` 函数进行了重要改进，解决了现有惩罚取消机制中的几个关键问题，使验证者惩罚系统更加智能和高效。

现有机制的问题：原始实现需要精确的惩罚键才能取消惩罚，且额外的违规报告可能创建更高惩罚比例的条目，使原有的取消操作失效。

主要改进内容：

- **新存储映射**：引入了 `CancelledSlashes` 存储映射，按 era 和验证者跟踪最大惩罚比例，提供更灵活的惩罚管理
- **调用签名优化**：将 `cancel_deferred_slash` 函数签名从复杂的惩罚键改为接受 `Vec<(AccountId, Perbill)>`，允许管理员直接指定要取消的验证者及其最大惩罚比例
- **智能清理机制**：在处理完某个 era 的所有惩罚后自动清除 `CancelledSlashes`，避免存储累积
- **事件简化**：更新了 `SlashCancelled` 事件，仅包含 era 和验证者信息，减少不必要的复杂性

**性能提升**：

通过基准测试，`cancel_deferred_slash` 性能显著提升，从 132.77ms 大幅降至 3.02ms，性能提升超过 40 倍。

这个优化使 Polkadot 的验证者惩罚系统更加智能化，提高了惩罚取消机制的灵活性和准确性，同时大幅降低了处理复杂惩罚场景的复杂性。

### 13. 优化 apply_authorized_force_set_current_code 函数性能

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9202) 优化了 `apply_authorized_force_set_current_code` 函数的实现，消除了不必要的整个区块消耗，显著提升了执行效率。

问题分析：该函数原本会消耗整个区块的计算资源，但实际上它只是将给定值写入存储，这种资源消耗是不必要的。

主要优化内容：

- **函数逻辑简化**：识别出该函数实际上只需要执行简单的存储写入操作，不需要复杂的区块级处理
- **资源消耗优化**：移除了不必要的整个区块消耗，仅在实际需要时执行系统级变更
- **执行条件细化**：在中继链上，只有在平行链实际发生变更时才需要特殊处理，而不是每次调用都进行完整处理

**技术影响**：

- 大幅减少了不必要的计算开销
- 提高了函数执行效率和系统整体性能
- 优化了资源分配，使系统能够处理更多并发操作

该 PR 已被合并到 master 分支，并计划在多个稳定版本分支（stable2503、stable2506、unstable2507）中回溯，确保所有用户都能受益于这一性能改进。

### 14. 修复 CandidateDescriptor 调试日志版本问题

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9255) 修复了 CandidateDescriptor 调试日志中的版本处理问题，确保不同版本的 CandidateDescriptor 能够正确地进行调试输出。

问题描述：无论 CandidateDescriptor 的实际版本如何，在调试日志中都会被显示为 CandidateDescriptorV2 实例，这导致了调试信息的不准确性。

主要修复内容：

- **版本感知调试**：修改了 CandidateDescriptor 的调试日志实现，使其能够根据实际版本进行准确的调试输出
- **条件编译优化**：
  - 仅在 std 未启用时派生 RuntimeDebug，避免 WASM 运行时膨胀
  - 在 std 启用时手动实现 core::fmt::Debug
- **版本特定输出**：基于具体的 CandidateDescriptor 版本打印不同的结构信息

**技术价值**：

- 提供了更准确和版本特定的调试信息
- 防止了不必要的运行时膨胀
- 改善了开发者的调试体验，特别是在处理不同版本的候选描述符时

**解决的问题**：

该 PR 解决了 Polkadot SDK 仓库中的 issue #8457，提升了跨不同运行时环境的调试能力。

这个修复对于维护和调试 Polkadot 网络中的候选验证流程具有重要意义，特别是在版本升级和兼容性测试场景中。


### 15. 修复即时密封节点的事务池初始化问题

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9338) 修复了 Polkadot SDK 中即时密封（instant seal）节点在事务池（transaction pool）初始化时的一个关键问题，提升了节点重启后的交易处理可靠性。

问题描述：即时密封节点在重启时，事务池可能无法正确处理已存在的区块和交易，导致交易验证出现问题。

主要修复内容：

- **初始化优化**：在事务池初始化时，使用最新的区块哈希（best_block_hash）创建初始视图，而不是仅使用创世区块
- **状态同步改进**：确保事务池在重启后能够正确识别最新区块状态，避免与区块链状态不一致
- **交易处理机制修复**：修复了即时密封节点的交易处理机制，确保重启后交易能正常验证和处理

**技术实现**：

- 修改了 `fork_aware_txpool` 中的初始化逻辑
- 确保事务池初始化时能够获得正确的区块链状态快照

**影响和价值**：

- 改善了即时密封节点的交易处理可靠性和稳定性
- 解决了区块重启后可能出现的交易验证问题
- 提升了开发和测试环境中即时密封节点的使用体验

这个修复对于使用即时密封节点进行开发测试的场景特别重要，确保了节点重启后的正常功能。

### 16. 修复基准测试框架中的跨版本编译器兼容性问题

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9354) 解决了 Rust 编译器在不同版本中对宏内标记（tokens）处理的空格问题，特别是在基准测试（benchmarking）框架中使用 `stringify` 宏时的兼容性问题。

问题背景：不同 Rust 编译器版本（特别是 1.87.0 之后）在生成的 token 字符串中空格处理存在不一致性，导致基准测试框架的行为不稳定。

主要修复内容：

- **宏输出规范化**：规范化 `stringify` 宏在嵌套宏中的输出结果，确保跨版本的一致性
- **空格处理统一**：移除标记周围可能出现的额外空格字符，解决不同编译器版本的差异
- **token 字符串一致性**：确保在 `<`、`>`、`::`等标记周围的空格处理保持一致

**技术细节**：

- 问题源于 Rust proc_macro 库中 `TokenStream` 的 `Display` 实现变化
- 根据 Rust 官方文档："输出的确切形式可能会发生变化，例如标记之间使用的空格可能会发生变化"
- 通过标准化处理确保了基准测试框架的稳定性

**影响和价值**：

- 修复了跨 Rust 编译器版本的基准测试宏行为
- 确保在生成运行时 WASM 时 token 名称的一致性  
- 解决了 Fellows 仓库中基准测试工具的潜在兼容性问题
- 提升了整个基准测试框架的稳定性和可靠性

该 PR 已被合并到主分支，并回溯到多个稳定发布分支，确保了所有版本的兼容性。

### 17. 修复 substrate-prometheus-endpoint 包的依赖配置

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9355) 修复了 `substrate-prometheus-endpoint` 包中的依赖和特性配置问题，解决了因第三方依赖升级导致的编译错误。

问题描述：`hyper-util` 包升级后不再间接启用 `tokio/net` 特性，导致 `substrate-prometheus-endpoint` 包在编译时出现依赖缺失错误。

主要修复内容：

- **直接特性依赖**：在 `Cargo.toml` 中明确要求启用 `tokio/net` 特性，不再依赖间接启用
- **依赖管理优化**：解决了因 `hyper-util` 升级导致的间接特性启用失效问题
- **编译稳定性提升**：确保包在不同依赖版本下都能稳定编译

**重现步骤**：
```bash
cargo update -p hyper-util
cargo check -p substrate-prometheus-endpoint
```

**技术实现**：

- 通过直接在依赖配置中要求 `net` 特性来修复编译问题
- 避免了对间接特性启用的依赖，提高了依赖管理的健壮性

**影响和价值**：

- 这不是破坏性变更，保持了向后兼容性
- 修复了特性依赖的潜在编译问题，提升了构建稳定性
- 已被回溯到多个稳定和不稳定版本分支

虽然这是一个相对较小的修复，但对于确保 Polkadot SDK 的编译稳定性和依赖管理健壮性具有重要意义。

### 18. 改进异步质押系统的权重报告和事件追踪

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9380) 对异步质押系统进行了重要改进，主要包括正确报告跨链消息权重和增强事件追踪能力。

该 PR 专注于提升异步质押系统的性能监控和状态追踪精确性，为系统运行提供更详细的可观测性。

主要改进内容：

- **跨链权重报告优化**：正确报告从 runtime client (rc) 到 async helper (ah) 的 XCM（跨链消息）权重，提高权重计算的准确性
- **权重感知机制**：使 XCM/消息队列代码路径能够感知权重，改善系统的资源管理和性能预测
- **事件追踪增强**：为被修剪的 era（纪元）添加了"Era Pruned"事件，提供更详细的系统状态信息
- **监控能力提升**：增强了区块链运行时的性能监控能力，便于系统状态分析

**技术价值**：

- 提高了权重计算的准确性，有助于更精确的费用估算和资源规划
- 为异步质押客户端提供了更详细的系统状态信息，便于监控和调试
- 改善了跨链操作的透明度和可追踪性

**部署状态**：

该 PR 已获得多位核心开发者的批准，包括 @sigurpol、@seadanda 和 @Ank4n，并成功合并到 master 分支。同时，已为 unstable2507 分支创建了回溯 PR。

这个改进对于提升 Polkadot 异步质押系统的运营可见性和性能监控能力具有重要意义，特别是在复杂的跨链操作场景中。

## 设计方案和问题讨论

### 1. Snowbridge 模块日志系统现代化改进

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9279) 对 Polkadot SDK 中的 Snowbridge 相关模块进行了日志系统的现代化改进，将传统的 `log` 日志记录替换为更先进的 `tracing` 框架。

该改进部分解决了 issue #9211 中关于"XCM over bridges"开发体验的问题，类似于之前的 PR #8732。

**主要改进内容**：

- **日志框架升级**：使用 `tracing` 替换 `log` 进行日志记录，提供更结构化和现代化的日志记录方式
- **零性能开销**：在运行时保持零性能开销，确保不影响系统性能
- **结构化日志**：
  - 使用一致的日志目标
  - 支持结构化字段格式
  - 通过 `?variable`/`%variable` 语法实现自动 Debug/Display 格式化

**技术特点**：

- 涉及 Snowbridge 和桥接相关的多个模块
- 共包含 97 个提交，影响 79 个文件
- 没有引入行为变更，仅改进可观测性

**意义和价值**：

这个改进旨在通过更现代和结构化的日志记录方式，显著提升代码的可观测性和开发体验，为 Snowbridge 桥接功能的调试和监控提供更好的工具支持。

### 2. Asset Hub Westend 本地网络的 parachain 信息配置优化

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9201) 为 Asset Hub Westend 本地网络添加了 `parachainInfo` 的创世补丁，解决了 parachain 启动和 ID 获取的关键问题。

该改进类似于已存在的 Asset Hub Rococo 本地网络的实现方式，确保了两个测试网络配置的一致性。

**主要改进内容**：

- **运行时 API 实现**：为 Asset Hub Westend 本地网络实现 `GetParachainInfo` 运行时 API
- **错误日志增强**：添加日志记录，在访问 `GetParachainInfo::parachain_id()` 运行时 API 时记录潜在错误
- **配置统一化**：与 Asset Hub Rococo 本地网络保持实现方式的一致性

**技术实现**：

- 修改了 `cumulus/parachains/runtimes/assets/asset-hub-westend/src/lib.rs`
- 在 `cumulus/polkadot-omni-node/lib/src/common/spec.rs` 中添加了相关日志处理

**设计讨论要点**：

在开发过程中，@skunert 建议移除 deprecation 日志，因为需要永久支持链规范中的 `para_id` 字段。这个讨论体现了在保持向后兼容性和系统清洁性之间的平衡考虑。

**影响和价值**：

提高了 Asset Hub Westend 本地网络的可靠性和调试能力，为开发者在本地环境中进行测试和开发提供了更好的支持。

### 3. Collator 协议连接机制的架构改进

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9178) 对 Polkadot SDK 中 Collator 协议的连接机制进行了重要的架构改进，解决了当前连接策略中的几个关键问题。

该改进主要针对 Collator 与验证者组之间的连接效率和稳定性进行了优化，特别是在弹性扩展场景下的连接及时性问题。

**主要设计改进**：

- **连接逻辑优化**：修复了连接到验证者组的逻辑缺陷
  - 之前只有在有区块广告时才连接验证者组
  - 现在改为立即连接分配的验证者组，不依赖区块广告状态
- **连接策略重构**：
  - 始终保持与当前分配的验证者组的连接
  - 减少不必要的连接建立和断开操作
- **日志优化**：减少冗余日志输出，改善系统可观测性

**设计讨论亮点**：

- **连接数限制讨论**：@ordian 指出了潜在的连接数限制问题，引发了对资源管理的深入思考
- **未来优化方向**：@alindima 提出了一个有前景的优化方案——提前通知即将出块的时间窗口，这为协议的进一步优化提供了方向

**架构影响**：

- 提高了 Collator 协议的连接效率和稳定性
- 为弹性扩展场景提供了更好的连接保障
- 为未来协议优化和改进奠定了基础

这个改进展现了对复杂网络协议连接管理的深入思考和系统性解决方案。

### 4. 争议分发模块的速率限制和退避机制设计

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9073) 对 Polkadot 网络中 `dispute-distribution` 模块的消息发送机制进行了重要的架构改进，引入了退避（backoff）机制来避免消息过载和提升网络稳定性。

该改进针对争议分发过程中的性能瓶颈和网络拥堵问题，提出了一套完整的速率限制解决方案。

**核心设计理念**：

- **退避策略**：通过添加退避机制，避免在发送 `DisputeRequest` 消息时过载接收方
- **细粒度控制**：为每个对等节点和每个任务添加独立的速率限制逻辑
- **自适应调节**：根据接收方的处理能力动态调整发送频率

**技术实现方案**：

- **被拒绝消息的退避策略**：实现针对被拒绝消息传递的指数退避算法
- **状态跟踪机制**：跟踪每个接收者的重试次数和最后重试时间
- **指数退避算法**：使用 `(2 ^ num_retries)` 公式控制重试间隔，平衡重试效率和网络负载

**设计讨论焦点**：

**潜在滥用场景的考量**：@eskimor 对设计中的潜在滥用场景表示担忧，认为单个节点可能通过声称导入失败来减慢整个争议分发过程。这引发了关于安全性与性能平衡的深入讨论。

**方案选择的权衡**：经过充分讨论，团队最终选择了每个对等节点和每个任务的退避机制方案，而不是全局速率限制，这个选择体现了对网络公平性和效率的综合考虑。

**架构价值**：

- **网络健壮性提升**：提高了网络消息传递的鲁棒性和容错能力
- **性能优化**：防止单个慢节点影响整个网络的争议分发效率
- **可扩展性增强**：为大规模网络部署提供了更好的性能保障

这个设计方案展现了在复杂分布式网络环境中对性能、安全性和公平性的精细平衡考虑。

## 技术生态和社区

### 1. 最新！Polkadot 更新 2025 路线图

Polkadot 2.0：2025 年 8 月下旬至 9 月初,如果你想快速向别人解释什么是 Polkadot 2.0，可以简单地说：它是一次对 Polkadot 网络能力的全面升级，为 Polkadot 和所有 parachain 带来更强的执行力和计算资源。
从结构上看，Polkadot 2.0 包含三个关键技术模块，其中已有两个正式上线，第三个正在准备中。

#### ✅ 已上线的两个功能：

1. Agile Coretime（灵活核心时间）

    这是一个全新的资源租赁机制，核心理念是：
    链可以像租云服务器一样，按月租用 Polkadot 的核心执行资源。
    目前，所有 parachains 都已转向在“核心时间市场”中运行，通过这种方式灵活购买执行时间。这让资源配置变得更加市场化，也大大提高了整体的可持续性。


2. Async Backing（异步支持）

    这是最早引入的一项协议升级，它让区块生产更加灵活：出块时间可快可慢；区块大小与频率也可以根据需求调整；整个系统进入弹性出块时代。
    目前所有 parachain 默认已经实现 6 秒出块，并保留进一步提速的能力，这为未来高频应用打下了基础。

#### 即将上线的第三个功能：Elastic Scaling（弹性扩展）

这项功能将真正带来 Polkadot 2.0 的“性能爆发”时刻：如果某个链需要更高计算能力或更大数据吞吐量，就可以按需租用多个 core。不再是固定资源，而是 “用多少，租多少”；支持不同应用根据自身需求动态扩展执行能力。
目前，这项功能正在进行最后的网络稳定性测试。根据核心开发者的反馈，预计将在 8 月下旬上线。考虑到当前已经是 7 月，即使有小幅延迟，我们也非常有可能在 8 月底或 9 月初看到正式发布。[在此处访问完整信息](https://mp.weixin.qq.com/s/f6gsEEA9VXkkLlEzlMatHQ)

### 2. 1,000 万 DOT 奖励，JAM Prize 邀你共建 Polkadot 下一代基础设施！

Web3 基金会发起了重磅计划，设有高达 1,000 万枚 DOT 和 10 万枚 KSM 的奖励池，正面向所有愿意投身下一代 Polkadot 协议构建的技术先锋开放。

作为 Polkadot 的下一代核心协议，JAM 代表着更高性能、更强灵活性的未来网络架构。而 JAM Prize 是 Web3 基金会重点推动的项目之一，旨在加速 JAM 协议的开发与落地。

通过 JAM Prize，Web3 基金会期待更多开发者投身 Polkadot 下一代协议的建设，一起构建更加开放、安全、自主的 Web3 基础设施！
[在此处访问完整信息](https://mp.weixin.qq.com/s/FHW04TftpYHj_yuSZ2zCPA)

### 3. Web3 Summit 在柏林圆满结束！Pudgy Party 预计在 8 月 29 日上线 Polkadot！

Web3 Summit 在柏林举行！Gavin Wood 在会议中再次投下“思想炸弹”：降低 Staking 激励！目标是将每年 5 亿美金的安全成本降低到 9000 万美金！同事提出短期解决方案专注在通过 OpenGov 调整一些经济参数，例如固定 DOT 总量 π×10⁹ DOT，每两年减半，逐年降低通胀；并通过多个机制来降低用户质押的意愿。 [在此处访问完整信息](https://mp.weixin.qq.com/s/AOKtZm1Wafh5O961znzIIw)

### 4. 波卡周报 | 多个项目表示将购买多个 Polkadot 核心！Hydration TVL 突破 3 亿美金！

最新进展！弹性扩展的目标是 8 月中到下旬上线 Polkadot！目前已经对弹性扩展表示出强烈兴趣的项目有：
- peaq：一个很受欢迎的平行链项目希望使用 Core，他们内部已经测试过同时使用 15 个 Core 的场景；
- Unique 有明确兴趣，还有 Origin trail（一个以数据为核心的链）、一些 NFT 链、甚至 Polkadot Hub 本身，都计划使用多个 Core；
- 游戏链 Mythical 甚至在研究是否可以为每一款游戏部署一条链 —— 这意味着每个游戏都对应一个 Core，这也是Mythical从以太坊迁移到 Polkadot 的原因！   

除此之外，像 Hyperbridge、Hydration、Frequency、MandalaChain、Polimec、Vbrick 等多个项目也表示希望能使用多个 Core，并正在等待弹性扩展的上线。

在中期解决方案上，希望引入 PoP（Proof of Personhood）+ Individuality，构建“身份驱动”安全模型！此外还推出一个重磅计划 —— 为 Polkadot 推出原生稳定币支付，构建生态内资金循环！[点击此处查看完整信息](https://mp.weixin.qq.com/s/Nt0m5caFijBLH6Em3jyuEw)

### 5. Polkadot Hub 启动用户增长计划！Hydration TVL 突破 2.5 亿美元

Polkadot Hub 正式启动用户增长计划！从 DeFi 到创新应用，从开发者工具到市场推广，一切都围绕一个目标：让 Polkadot Hub 成为最友好的以太坊兼容平台！

Parity 与生态伙伴制定了三大阶段的增长策略：
1. 以太坊开发者优先：打造丝滑的兼容体验，让你感觉像在用 L2。同时引入关键基础设施提供商，比如托管服务、流动性提供者，为生态打好基础。
2. DeFi 先行：DeFi 是一切的起点，通过 Velocity Labs 启动 DeFi Builders Program，全力吸引流动性与开发者。Parity 认为 DeFi 是其他领域的基础，有了强大的 DeFi，其他应用也才能活跃。
3. 明年开启创新阶段：重点支持那些基于 PolkaVM 构建的创新应用，比如支持 JIT 编译、运行加密密集型算法的智能合约等，这一阶段会举办更多 PolkaVM 专属的黑客松和开发者活动。

[点击此处查看完整信息](https://mp.weixin.qq.com/s/rGcbK9VVkuE6YZGxPeXIsg)

### 6. 重磅！Polkadot 推出的 PolkaVM 智能合约已正式上线 Kusama！

重大更新！ Kusama 今天正式上线了全新网站，但最重要的是推出了以太坊兼容的智能合约功能，但是基于全新的 PolkaVM 架构。
这不是另一个 EVM 克隆，而是一个速度更快、模块化程度更高、兼容以太坊生态工具的全新的 Web3 合约平台。[点击此处查看完整信息](https://mp.weixin.qq.com/s/p-0oxO7ACTrKGOeeNgpd_A)

## 跨链协议

### 1. XCM 预编译接口函数重命名和文档改进

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9023) 对 XCM Solidity 预编译接口进行了重要的函数重命名和文档改进，旨在提高接口的清晰度和开发者体验。

主要变更内容：

- **函数名简化**：
  - `xcmExecute()` 重命名为更简洁的 `execute()`
  - `xcmSend()` 重命名为 `send()`

- **ABI 兼容性变更**：函数选择器发生变化，这是一个重大的破坏性变更
  - `xcmSend(bytes,bytes)`: 从 `0xc0addb55` 变更为 `0x7f0a3bf9`
  - `xcmExecute(bytes,(uint64,uint64))`: 从 `0x377df829` 变更为 `0xd3b7e04d`

- **文档完善**：
  - 在 Solidity 接口（IXcm.sol）中添加了指向官方 Polkadot XCM 文档的链接
  - 明确说明函数返回值与 `pallet_xcm::send()` 和 `pallet_xcm::execute()` 的返回值匹配
  - 详细补充了每个函数、参数、返回值的说明

**重要提醒**：由于修改了 ABI 编码的函数选择器，这是一个重大不兼容变更。所有依赖这些接口的智能合约都需要同步升级以适应新的函数名和选择器。

这个改进使 XCM 预编译接口更加简洁易用，同时提供了更完善的开发者文档支持。

### 2. XCM 预编译限制支持版本至 V5 及以上

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9126) 对 XCM（跨共识消息）预编译进行了版本限制，仅支持 XCM 版本 5 及以上，简化了合约实现并提高了前瞻性。

尽管许多平行链仍在使用 XCM 版本 3 和 4，但新的 XCM 预编译专注于支持最新版本，避免了向前拖拽旧版本的复杂性。

主要变更内容：

- **版本检查机制**：添加了版本检查以防止处理低于版本 5 的 XCM 消息
- **操作覆盖**：为 XCM 的 "send" 和 "weigh" 操作都实现了版本检查
- **测试完善**：添加了包括 V3 在内的版本处理测试，确保版本过滤的正确性
- **代码简化**：
  - 修改预编译逻辑以明确拒绝旧版本 XCM
  - 统一版本检查函数以保持一致性
  - 减少了合约级 XCM 处理的复杂性

**影响和意义**：

- 将 XCM 预编译聚焦于最新的 XCM 版本，确保向前兼容性
- 为合约开发者提供了清晰的版本支持边界
- 简化了实现逻辑，降低了维护成本

这个变更体现了 Polkadot 对于保持技术前瞻性和简化开发体验的承诺。

### 3. 扩展 pallet-xcm 的常量暴露

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9139) 扩展了 pallet-xcm 模块中暴露的常量数量，提升了 XCM（跨共识消息）配置的透明性和可访问性。

这个改进类似于现有的 `AdvertisedXcmVersion` 常量，为开发者提供了更多可访问的内部常量。

主要改进内容：

- **常量暴露增强**：增加了 XCM pallet 中暴露的配置常量数量，提供了更完整的配置信息访问
- **开发者体验提升**：允许开发者访问更多与 XCM 版本控制和配置相关的内部常量
- **透明性改进**：提高了 XCM pallet 配置的透明度，便于外部系统和开发工具获取配置信息

**部署策略**：

该 PR 采用了全面的回溯策略，已被合并到多个版本分支：

- stable2409
- stable2412  
- stable2503
- stable2506
- unstable2507

这个改进为 XCM 生态系统的开发者提供了更好的工具支持和配置访问能力，有助于构建更强健的跨链应用。

### 4. XCMv5 跨链资产交换测试场景实现

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9195) 为 Polkadot SDK 引入了全面的 XCMv5 资产交换测试场景，验证了跨链资产转账和交换的多种实现方式。

该 PR 实现了三个关键的测试场景，涉及 Penpal 和 AssetHub 平行链之间的复杂跨链操作：

#### 场景一：使用授权别名的远程交易

- 演示了使用 `add_authorized_alias` 在远程链上以发送者身份进行交易
- 关键步骤：
  1. 准备主权账户资金和流动性池
  2. 从 Penpal 向 AssetHub 发送 WND
  3. 别名到发送者账户
  4. 使用 `Transact` 将 WND 交换为 USDT
  5. 将 USDT 和剩余 WND 发送回 Penpal

#### 场景二：无别名的远程交易

- 类似于场景一，但不使用授权别名机制
- 直接使用 `Transact` 进行 WND 到 USDT 的交换

#### 场景三：ExchangeAsset 指令

- 使用 `ExchangeAsset` XCM 指令替代 `Transact`
- 实现跨链的 WND 到 USDT 资产交换

**技术价值**：

- 验证了跨链资产交换机制的不同实现方式
- 测试了 XCM v5 的核心功能和兼容性
- 为复杂的跨链交互工作流程提供了参考实现
- 展示了不同的跨链交互方法和最佳实践

这些测试场景为开发者提供了完整的跨链资产交换模式参考，有助于构建更复杂的多链应用。

### 5. HRMP 消息顺序检查机制实现

[本 PR](https://github.com/paritytech/polkadot-sdk/pull/9326) 在 Polkadot SDK 的 Cumulus 模块中为 HRMP（水平中继链消息传递）消息添加了顺序检查机制，确保跨链消息传递的可靠性和正确性。

该改进与之前的 PR #8860 相关，是 Cumulus 模块持续改进的一部分。

主要改进内容：

- **消息顺序验证**：在 parachain-system 模块中添加了消息顺序验证逻辑，确保 HRMP 消息按正确顺序入队
- **核心检查方法**：通过 `check_messages_order()` 方法检查消息是否按正确顺序排列
- **错误处理机制**：如果检测到消息顺序不正确，将阻止消息入队，防止潜在的处理问题
- **全面测试覆盖**：
  - 添加了多个测试用例，覆盖正确和错误的消息排序场景
  - 确保了代码在各种边界条件下的健壮性

**技术影响**：

- 提高了跨链消息传递的可靠性和一致性
- 防止了因消息顺序错乱导致的潜在处理问题
- 为平行链之间的消息通信提供了额外的安全保障

**重要性**：

这个机制对于维护 Polkadot 生态系统中平行链间通信的完整性具有重要意义，特别是在高并发的跨链消息传递场景中，确保消息按预期顺序处理，避免状态不一致问题。
